# Salesforce パッケージの構造整理とリファクタリング

**日付**: 2025-10-19
**ステータス**: 計画中

## 目的

- src/ 以下を役割別に整理（models, core, react, electron）
- Salesforce関連コードを @toolbox/salesforce パッケージに集約
- 環境別エントリポイント（client.ts, server.ts, electron.ts）を提供

## 背景

現状のディレクトリ構造では、React関連（context, hooks）とNode.js関連（core）が混在しており、責務が不明確。また、Electron統合コードが packages/\_\_electron 側に散在しているため、他のワークスペースから Salesforce 機能を利用しづらい。

## 完成形のディレクトリ構造

```
packages/__salesforce/src/
├── models/                    # 型定義（環境非依存）
│   ├── ConnectionState.ts
│   ├── OAuthConfig.ts
│   ├── OrgInfo.ts
│   ├── PKCEParams.ts
│   ├── SalesforceTokens.ts
│   ├── LoginHistoryRecord.ts
│   └── index.ts
├── core/                      # Node.js / jsforce関連
│   ├── connection.ts
│   ├── oauth.ts
│   ├── pkce.ts
│   ├── constants.ts
│   ├── singleton.ts          # NEW: getSalesforceConnection() 実装
│   └── index.ts
├── react/                     # React関連
│   ├── context/              # MOVED: src/context/ から移動
│   │   ├── SalesforceContext.tsx
│   │   ├── SalesforceProvider.tsx
│   │   └── index.ts
│   ├── hooks/                # MOVED: src/hooks/ から移動
│   │   ├── useSalesforce.tsx
│   │   ├── window.d.ts
│   │   └── index.ts
│   └── index.ts              # NEW
├── electron/                  # MOVED: packages/__electron/src/__extensions/salesforce/ から移動
│   ├── main.ts               # IPC ハンドラー、getSalesforceConnection()を使用
│   ├── preload.ts            # IPC API公開
│   ├── shared.ts             # 型・チャンネル定義
│   └── index.ts              # NEW
├── client.ts                  # NEW: Renderer Process用エントリポイント
├── server.ts                  # NEW: Node.js用エントリポイント
├── electron.ts                # NEW: Electron統合用エントリポイント
├── cli.ts
└── main.ts
```

## エントリポイントの設計

### src/client.ts (Renderer Process 用)

```typescript
// Renderer Process / React Components 用
export { useSalesforce } from './react/hooks';
```

**用途**: 業務機能ワークスペースのGUIコンポーネント

### src/server.ts (Node.js 用)

```typescript
// 純粋な Node.js 環境用
export { SalesforceConnection } from './core/connection';
export { getSalesforceConnection } from './core/singleton';
export { buildAuthorizationUrl, exchangeCodeForTokens, refreshAccessToken } from './core/oauth';
export { generatePKCEParams } from './core/pkce';
export { CLIENT_ID, REDIRECT_URI, INSTANCE_URLS } from './core/constants';
export type { SalesforceTokens, OAuthConfig, PKCEParams, OrgInfo, ConnectionState } from './models';
```

**用途**: 業務機能ワークスペースのNode.jsビジネスロジック

### src/electron.ts (Electron Main Process 用)

```typescript
// Electron Main Process 統合用
export {
  registerSalesforceHandlers,
  unregisterSalesforceHandlers,
  setProtocolUrlHandler,
} from './electron';
export type { SalesforceAPI, SalesforceTokens, ConnectionState, OrgInfo } from './electron/shared';
```

**用途**: Electronアプリケーションのメインプロセス統合

## 新規実装: singleton.ts

### src/core/singleton.ts

```typescript
import { SalesforceConnection } from './connection';

let instance: SalesforceConnection | null = null;

export const getSalesforceConnection = (): SalesforceConnection => {
  if (!instance) {
    instance = new SalesforceConnection();
  }
  return instance;
};

export const resetSalesforceConnection = (): void => {
  instance = null;
};
```

**目的**: アプリケーション全体でSalesforceConnectionインスタンスを一元管理

## 使用例（業務機能ワークスペース）

```
packages/some-feature/          # 業務機能ワークスペース
├── gui/                       # Renderer Process
│   └── Component.tsx
│       import { useSalesforce } from '@toolbox/salesforce/client';
│
├── core/                      # Node.js ビジネスロジック
│   └── business.ts
│       import { getSalesforceConnection } from '@toolbox/salesforce/server';
│       const conn = getSalesforceConnection().getConnection();
│       if (conn) {
│         await conn.sobject('Account').describe();
│       }
│
└── electron/                  # Main Process 統合
    └── main.ts
        import { someProcess } from '../core/business';

        ipcMain.handle('some-feature:action', async () => {
          return someProcess();
        });
```

## 実装ステップ

### 1. ディレクトリ移動

```bash
# React関連を react/ 配下に移動
mv src/context/ src/react/context/
mv src/hooks/ src/react/hooks/

# Electron統合を electron/ 配下に移動
mv packages/__electron/src/__extensions/salesforce/ packages/__salesforce/src/electron/
```

### 2. 新規ファイル作成

- `src/core/singleton.ts` - getSalesforceConnection() 実装
- `src/client.ts` - Renderer Process用エントリポイント
- `src/server.ts` - Node.js用エントリポイント
- `src/electron.ts` - Electron統合用エントリポイント
- `src/react/index.ts` - React関連の re-export
- `src/electron/index.ts` - Electron統合の re-export

### 3. electron/main.ts の変更

**Before:**

```typescript
const tokenStore = new InMemoryTokenStore();
const salesforceConnection = new SalesforceConnection();
```

**After:**

```typescript
import { getSalesforceConnection } from '../core/singleton';

const tokenStore = new InMemoryTokenStore();
// salesforceConnection 変数は削除
// 使用箇所は全て getSalesforceConnection() に置き換え
```

### 4. package.json 更新

```json
{
  "name": "@toolbox/salesforce",
  "exports": {
    "./client": "./src/client.ts",
    "./server": "./src/server.ts",
    "./electron": "./src/electron.ts"
  }
}
```

### 5. インポートパス更新

**packages/\_\_electron/src/main/index.ts:**

```typescript
import {
  registerSalesforceHandlers,
  setProtocolUrlHandler,
  unregisterSalesforceHandlers,
} from '@toolbox/salesforce/electron';
```

**packages/\_\_electron/src/renderer/src/App.tsx:**

```typescript
import { SalesforceProvider } from '@toolbox/salesforce/react/context';
```

**packages/\_\_electron/src/renderer/src/components/MenuFooterOrgInfo.tsx:**

```typescript
import { useSalesforce } from '@toolbox/salesforce/client';
```

### 6. 検証

```bash
npm run typecheck
npm run lint
npm run dev  # 動作確認
```

## メリット

### 1. 責務の明確化

- **models/**: 環境非依存の型定義
- **core/**: Node.js/jsforce関連のビジネスロジック
- **react/**: React統合（hooks, Context）
- **electron/**: Electron Main Process統合

### 2. 再利用性の向上

- 業務機能ワークスペースから `@toolbox/salesforce/server` で簡単にjsforce機能にアクセス可能
- GUI部品は `@toolbox/salesforce/client` から利用

### 3. シングルトンパターンによる一元管理

- `getSalesforceConnection()` でアプリケーション全体のConnectionインスタンスを統一
- 複数箇所でConnectionを生成する問題を回避

### 4. 保守性の向上

- 関連コードが1つのパッケージに集約
- ディレクトリ構造が整理され、コードの所在が明確

## 注意点

- 既存のインポートパス（`@toolbox/salesforce/src/xxx`）は段階的に新しいパスに移行
- `getSalesforceConnection().getConnection()` が null を返す可能性があるため、各呼び出し箇所でnullチェック必須

## TODO

- [ ] ディレクトリ移動
- [ ] 新規ファイル作成
- [ ] electron/main.ts の変更
- [ ] package.json 更新
- [ ] インポートパス更新
- [ ] typecheck & lint
- [ ] 動作確認
- [ ] コミット
