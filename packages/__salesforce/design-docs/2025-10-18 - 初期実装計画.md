# Salesforce基盤実装の計画

## 採用方式

- OAuth 2.0 Authorization Code Flow with PKCE（Client Secret不要）
- ビジネスロジックは `packages/__salesforce/` に集約
- Electron Extensionは薄いブリッジ
- **トークンは永続化せず、Main processのメモリで保持**
- ログインは任意（Salesforce依存機能でのみLoginGateを表示）

## 実装内容

### 1. 依存パッケージの追加

**`packages/__salesforce/package.json`**:

- `jsforce` を dependencies に追加

**`packages/__electron/package.json`**:

- `"@toolbox/salesforce": "^0.0.0"` をワークスペース依存として追加

### 2. Salesforceワークスペースのモデル定義 (`packages/__salesforce/src/models/`)

**OAuthConfig.ts**:

- `OAuthConfig` 型: `instanceUrl`, `clientId`, `redirectUri`

**PKCEParams.ts**:

- `PKCEParams` 型: `code_verifier`, `code_challenge`, `code_challenge_method`

**SalesforceTokens.ts**:

- `SalesforceTokens` 型: `access_token`, `refresh_token`, `instance_url`

**OrgInfo.ts**:

- `OrgInfo` 型: `orgId`, `orgName`, `username`, `email`, `userId`

**ConnectionState.ts**:

- `ConnectionState` 型: `'disconnected'` | `'connecting'` | `'connected'` | `'error'`

**LoginHistoryRecord.ts**:

- `LoginHistoryRecord` 型: LoginHistoryオブジェクトのレコード型
  - `Id`: string
  - `LoginTime`: string（ISO 8601形式）
  - `Status`: string（'Success' | 'Failed' | その他）
  - `Browser`: string | null
  - `Platform`: string | null
  - `SourceIp`: string | null

**index.ts**:

- 全ての型をre-export

### 3. Salesforceワークスペースのコア実装 (`packages/__salesforce/src/core/`)

**constants.ts**:

- `CLIENT_ID`: 環境変数から注入（開発時はハードコード可）
- `REDIRECT_URI`: ルートpackage.jsonのnameから動的生成

  ```typescript
  import rootPackageJson from '../../../../package.json';

  export const REDIRECT_URI = `${rootPackageJson.name}://oauth/callback`;
  ```

- `INSTANCE_URLS`:
  - `PRODUCTION`: `'https://login.salesforce.com'`
  - `SANDBOX`: `'https://test.salesforce.com'`

**pkce.ts**:

- `generateCodeVerifier()`: 43-128文字のランダム文字列生成
- `generateCodeChallenge(verifier: string)`: SHA-256でcode_challenge計算

**oauth.ts**:

- `buildAuthorizationUrl(config: OAuthConfig, pkce: PKCEParams)`: 認証URL構築
- `exchangeCodeForTokens(code: string, verifier: string, config: OAuthConfig)`: jsforceでトークン交換
- `refreshAccessToken(refreshToken: string, config: OAuthConfig)`: トークンリフレッシュ

**connection.ts**:

- `SalesforceConnection` クラス（jsforceラッパー）
  - `connect(tokens: SalesforceTokens)`: 接続確立
  - `getOrgInfo()`: 組織情報取得
  - `getUserInfo()`: ユーザー情報取得
  - `query<T>(soql: string)`: SOQLクエリ実行（jsforceのqueryメソッドをラップ）
  - `disconnect()`: 切断

### 4. Salesforceワークスペースのフック実装 (`packages/__salesforce/src/hooks/`)

**useSalesforce.ts**:

- State管理:
  - `connectionState`: ConnectionState
  - `orgInfo`: OrgInfo | null
  - `connection`: SalesforceConnection | null
- 関数:
  - `login(instanceUrl: string)`: Electron API経由でログイン開始
  - `logout()`: ログアウト処理
- コンポーネント:
  - `LoginGate: React.FC<{ children: React.ReactNode }>`:
    - 認証済み → children表示
    - 未認証 → LoginForm表示
- 初期化:
  - 起動時は常に未認証状態
- 返却値:
  - `connectionState`, `orgInfo`, `connection`, `login`, `logout`, `LoginGate`

**index.ts**:

- `useSalesforce` をエクスポート

### 5. Electron Extension実装（薄いブリッジ + メモリ内トークン管理）(`packages/__electron/src/__extensions/salesforce/`)

**shared.ts**:

- IPCチャンネル定義:
  - `salesforce:login`
  - `salesforce:logout`
  - `salesforce:get-org-info`
  - `salesforce:get-connection-state`
- `SalesforceAPI` 型定義
- モデル型のre-export（`@toolbox/salesforce/src/models`から）

**main.ts**:

- `InMemoryTokenStore` クラス:
  - `tokens`: SalesforceTokens | null（メモリ保持）
  - `setTokens(tokens: SalesforceTokens)`: トークン保存
  - `getTokens()`: トークン取得
  - `clearTokens()`: トークン削除
- `registerSalesforceHandlers()`:
  - `salesforce:login` handler:
    - PKCE生成（`@toolbox/salesforce/src/core/pkce`）
    - BrowserWindowで認証画面表示
    - カスタムURLスキームから認証コード取得
    - トークン交換（`@toolbox/salesforce/src/core/oauth`）
    - `InMemoryTokenStore` に保存
  - `salesforce:logout` handler:
    - `InMemoryTokenStore.clearTokens()`
  - `salesforce:get-org-info` handler:
    - `InMemoryTokenStore.getTokens()` でトークン取得
    - SalesforceConnectionで組織情報取得
  - `salesforce:get-connection-state` handler:
    - トークン有無でconnection state返却
- `unregisterSalesforceHandlers()`:
  - トークンクリア（ログアウト通知は不要、アプリ終了時処理で対応）

**preload.ts**:

- `buildSalesforceAPI()`: Renderer側へのAPI公開
  - `login(instanceUrl: string): Promise<boolean>`
  - `logout(): Promise<void>`
  - `getOrgInfo(): Promise<OrgInfo | null>`
  - `getConnectionState(): Promise<ConnectionState>`

### 6. Preload/型定義の更新

**`packages/__electron/src/preload/index.ts`**:

- `salesforce: buildSalesforceAPI()` を api オブジェクトに追加

**`packages/__electron/src/preload/index.d.ts`**:

- `Window` interface に `salesforce?: SalesforceAPI` 追加

### 7. Main プロセスの更新

**`packages/__electron/src/main/index.ts`**:

- `registerSalesforceHandlers()` / `unregisterSalesforceHandlers()` 呼び出し
- `app.setAsDefaultProtocolClient('toolbox-framework')` でカスタムURLスキーム登録
- `app.on('will-quit')` でログアウト処理:
  - トークンが存在する場合、トースト通知「Salesforceからログアウトしました」
  - トークンクリア

### 8. GUI実装 (`packages/__salesforce/gui/`)

**components/LoginForm.tsx**:

- インスタンスURL選択:
  - RadioGroup: `Production` / `Sandbox` / `Custom`
  - Custom選択時に TextField表示（URLバリデーション付き）
- ログインボタン
- Props: `onLogin(instanceUrl: string): Promise<void>`

**components/OrgInfo.tsx**:

- 組織名、組織ID表示
- ユーザー名、メールアドレス表示
- ログアウトボタン
- Props: `orgInfo: OrgInfo`, `onLogout(): Promise<void>`

**components/MenuFooterOrgInfo.tsx**（新規）:

- **Electronアプリ左メニュー左下に固定表示するコンパクトコンポーネント**
- 表示内容:
  - 組織名（略称）または「未接続」
  - ログアウトボタン（アイコン）
- `useSalesforce` 使用
- スクロールに関係なく、ウィンドウ左下に常駐

**components/LoginHistoryTable.tsx**（新規・実用例）:

- **ログイン中ユーザー自身のログイン履歴を表示するテーブルコンポーネント**
- データ取得:
  - `useSalesforce().connection` を使用
  - SOQL: `SELECT Id, LoginTime, Status, Browser, Platform, SourceIp FROM LoginHistory WHERE UserId = '${currentUserId}' ORDER BY LoginTime DESC LIMIT 10`
  - `useEffect` でログイン成功時に自動取得
- 表示列:
  - ログイン日時（LoginTime）: 日本語フォーマット
  - ステータス（Status）: Success / Failed など
  - ブラウザ（Browser）
  - プラットフォーム（Platform）
  - IPアドレス（SourceIp）
- UI:
  - React Spectrum の `TableView` を使用
  - ローディング状態表示
  - エラー時のメッセージ表示
- Props: なし（`useSalesforce` から直接取得）

**App.tsx**（実用例デモ）:

- `useSalesforce` でLoginGate, orgInfo, connection取得
- LoginGateでラップして以下を表示:
  - 組織情報（OrgInfo）
  - ログイン履歴テーブル（LoginHistoryTable）
- レイアウト: Heading + OrgInfo + LoginHistoryTable の縦並び

### 9. Electronメニューの更新

**`packages/__electron/src/renderer/src/components/Nav.tsx`**:

- `MenuFooterOrgInfo` コンポーネントをインポート
- NavPanelをFlexboxレイアウトに変更:
  - 上部（Header + SideNav）: スクロール可能領域
  - 下部（MenuFooterOrgInfo + Versions）: 固定表示領域
- レイアウト構造:

  ```tsx
  <NavPanel>
    {/* スクロール可能な上部エリア */}
    <Flex direction="column" flex="1" UNSAFE_style={{ overflow: 'auto' }}>
      <Header>...</Header>
      <Spectrum.SideNav>...</Spectrum.SideNav>
    </Flex>

    {/* 固定表示の下部エリア */}
    <Flex direction="column" UNSAFE_style={{ marginTop: 'auto' }}>
      <MenuFooterOrgInfo />
      <Versions />
    </Flex>
  </NavPanel>
  ```

- NavPanelのスタイル調整: `display: flex`, `flex-direction: column`, `min-height: 100vh`

### 10. PKCEフロー詳細

1. ユーザーがインスタンスURL選択（Production/Sandbox/Custom入力） → ログインボタンクリック
2. `useSalesforce().login(instanceUrl)` → Renderer → IPC → Main
3. Main: PKCE生成（`generateCodeVerifier`, `generateCodeChallenge`）
4. Main: 認証URL構築（code_challenge付き）
5. Main: BrowserWindowで認証画面表示
6. ユーザーがSalesforceで認証
7. Salesforce → `toolbox-framework://oauth/callback?code=xxx`
8. Main: カスタムURLスキームで認証コード受け取り
9. Main: トークン交換（`exchangeCodeForTokens`）
10. Main: `InMemoryTokenStore` に保存（メモリのみ）
11. Renderer: LoginGateがconnectionState変化を検知してchildren表示
12. 組織情報取得してOrgInfo表示

### 11. アプリ終了時の処理

- `app.on('will-quit')`:
  - トークン存在チェック
  - 存在する場合、トースト通知「Salesforceからログアウトしました」
  - トークンクリア（メモリから削除）

## 技術的な注意点

- jsforceのPKCE対応確認が必要（未対応なら直接fetch実装）
- カスタムURLスキームはOS別動作確認必要
- トークンはメモリのみ保持（アプリ再起動で消失）
- リフレッシュトークンの自動更新は後回し（初期実装では手動再ログイン）
- 将来の永続化対応は必要になったら設計

## LoginHistoryTable実装の注意点

- ログイン中ユーザーIDは `OrgInfo.userId` から取得
- LoginHistoryオブジェクトへのアクセス権限が必要（一般的にはユーザー自身の履歴は閲覧可能）
- LoginTimeはISO 8601形式で返ってくるため、日本語フォーマットへの変換が必要
- Browser、Platform、SourceIpはnullの可能性があるため、nullチェックと表示処理が必要
- エラーハンドリング: 権限不足やネットワークエラーに対応
