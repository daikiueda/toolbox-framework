# multiple-bulk-export Design Doc

## 背景

- Salesforce の複数オブジェクト（カスタムを中心に、必要に応じて標準も含む）を横断してエクスポートしたいニーズがあるが、既存機能では単一オブジェクトまたは標準 UI を経由する必要があり、手間と時間がかかる。
- プロセスビルダーや外部 ETL に頼らず、Electron ワークスペースから一括でデータを抽出できる仕組みを提供したい。
- 大量データでも最大限の速度を引き出すため、Bulk API による並列処理を前提とした設計が必要。

## ゴール

- ユーザーが複数の Salesforce オブジェクト名を指定するだけで、全レコードを CSV 形式で高速エクスポートできる。
- GUI から呼び出す共通のドメイン層を用意し、再利用しやすい構造を整備する。
- 実行状況や失敗理由をユーザーが把握できるよう、進捗表示とエラーログを整備する。

## 非ゴール

- データの変換・加工（マッピング、集計、個人情報のマスク）は行わない。
- インポートや双方向同期は対象外。

## ユースケース

- 担当者が Salesforce 側の変更監査やバックアップのために、適時複数オブジェクトの CSV を取得したい。
- 開発・検証環境で複数オブジェクトのデータスナップショットを取得し、ローカルで diff や参照に利用したい。
- 障害調査時に特定オブジェクト群の最新状態を一括エクスポートし、ログや BI ツールに取り込んで分析したい。

## 成功指標

- 10 万件クラスのレコードを含む 3 オブジェクトのエクスポートが 5 分以内に完了する。
- エクスポート失敗時に失敗オブジェクトと理由が GUI で明示される。
- 出力ファイルがタイムスタンプ付きディレクトリにまとまり、再利用・共有が容易である。

## 仕様サマリ

- **GUI**: オブジェクト API 名を改行区切りで入力するテキストエリア、保存先ディレクトリの指定、進捗バー、ログ出力、完了後の出力フォルダを開く操作を提供。
- **出力**: デフォルトでディレクトリ構造 `exports/<OrgName>/<timestamp>/<ObjectName>.csv` を作成しつつ、GUI から任意フォルダを選べるようにする（OrgName はファイルシステム向けにサニタイズし、取得できない場合は OrgId を利用）。
- **Salesforce 接続**: 既存の `SalesforceConnection`（jsforce）を再利用し、Bulk API 2.0 Query ジョブを発行。

## 機能要件

- オブジェクト入力
  - テキストエリアに改行区切りでオブジェクト API 名（例: `CustomObject__c`, `User`）を入力させ、以下のバリデーションを行う。
    - 空行や空白のみの行は無視し、入力が 1 件も残らない場合はエラー。
    - 先頭／末尾の空白をトリムし、API 名が英数字・アンダースコア以外の文字を含む場合はエラー。
    - 標準オブジェクトも許容し、DescribeGlobal の結果をもとに入力値を正規の API 名へ正規化する（大文字・小文字の違いは許容）。
    - 正規化後に同じ API 名が複数回入力された場合は重複として警告し、重複を除外して処理。
  - DescribeGlobal + DescribeSObject を用いて存在確認とフィールド一覧取得を実施し、Salesforce 側に存在しない API 名はエラーとしてユーザーに提示。
- 保存先指定
  - Electron の `dialog.showOpenDialog` でディレクトリ選択ダイアログを開き、ユーザーが保存先を決められるようにする。
  - 指定がない場合は既定の `exports/<OrgName>/<timestamp>` パスを利用し（OrgName が取得できない場合は OrgId）、選択結果はセッション中保持する。
- エクスポート実行
  - DescribeSObject で取得した全フィールド（標準項目を含む）を SOQL に展開し、`SELECT <fields...> FROM <Object>` を構築。
  - Bulk API 2.0 Query Job を作成し、完了するまでポーリング。
  - 完了後の結果ファイルをダウンロードし、ローカルに保存。
- 進捗・ログ
  - 全体サマリーとして、対象オブジェクト総数・完了数・エラー数を常に表示。
- 各オブジェクトごとにステータス（待機中→実行中→完了/失敗）、総レコード数（`numberRecordsTotal` が判明したタイミングで表示）、プログレスバー、取得済みレコード数を表示。
  - 総レコード数が不明な間はプログレスバーをインジケータ（ストライプなど）表示にし、`numberRecordsTotal` 取得後に確定値との割合を表示。
  - 追加の `SELECT COUNT()` クエリは発行せず、Bulk API 2.0 のジョブ情報から得られる値のみを利用。
  - Salesforce から得られたエラー情報を人間が理解できる形で提示。
- 設定保存
  - 直近で選択したオブジェクトリストをローカル設定（Electron Store）に保存し、次回デフォルト選択とする（MVP では履歴 1 件）。

## 非機能要件

- 高速化: Bulk API 2.0 Job を最大 5 並列（環境変数で調整可能）で実行し、Salesforce 同時実行制限を考慮。
- 冪等性: 同じオブジェクトを複数回指定しても最新の結果のみが残る。
- ストレージ: 1 ジョブあたり最大 1GB を想定し、ダウンロード失敗時は部分的なファイルを削除。
- 障害時リカバリ: タイムアウト・レート制限・一時的障害の際に、リトライ（指数バックオフ、最大 3 回）を実装。

## Salesforce 連携と制約

- Bulk API 2.0 は 10 個まで同時ジョブ実行可能。MVP では 5 並列で様子を見つつ、キュー制御を実装。
- `SELECT *` は許可されないため、DescribeSObject でフィールド一覧を取得し、クエリを組み立てる。
- DescribeSObject の結果は標準項目（Id, Name, OwnerId, CreatedDate など）を含めてすべて取り込み、欠損がないようにする。
- 参照関係フィールド（外部参照）は 18 文字の ID のみを出力対象とし、展開はしない。
- 大規模オブジェクトで `PK Chunking` が必要な場合は将来検討（MVP では非対応）。

## アーキテクチャ

- **レイヤ**:
  - `gui/` : React Spectrum ベースの UI。`useSalesforce` フック経由で認証状態を確認し、ドメインサービスを呼び出す。
  - `src/models` : エクスポート対象やジョブ状態の型定義。
  - `src/repositories` : Salesforce API への薄いラッパー層。Describe・Bulk Job 作成・結果取得を担当。
  - `src/services` : エクスポート orchestration。並列実行制御とファイル I/O を共通化。新規追加予定。
  - `src/usecases` : GUI のエントリポイントから呼ばれるユースケース層を追加。
- **データフロー**:
  1. GUI でオブジェクト名のリストを受け取る。
  2. `ExportService` が `DescribeRepository` を利用してフィールドリスト（標準項目を含む全フィールド）を取得し、SOQL を組み立てる。
  3. `BulkExportRepository` が Bulk Job を作成し、完了までポーリング。
  4. 完了後、結果ファイルをダウンロードしてローカルに保存。ファイルパスをユースケース層へ返却。
  5. ユースケース層が UI に進捗更新・完了通知を行う。

## UI/UX 方針

- 既存ワークスペースと統一したヘッダー＋LoginGate 構成。
- テキストエリアでオブジェクト名を入力し、入力値のバリデーション結果をリアルタイムに表示。
- 実行中はキャンセルボタンと、オブジェクトごとのステータス一覧を表示。
- 完了後は OS のファイルブラウザを開くボタンを表示（`shell.openPath`）。

## データ・ファイル構造

- ディレクトリ: `exports/<OrgName>/<YYYYMMDD-HHmmss>/`（ユーザーが任意フォルダを選んだ場合はその配下）。OrgName はファイルシステム用にサニタイズし、取得不可時は OrgId を利用。
- ファイル名: `<ObjectName>.csv`

## エラーハンドリング / ログ

- Salesforce API からの HTTP エラーはリトライ制御を付与し、許容回数を超えたら失敗として記録。
- ダウンロード中のネットワークエラーは 2 回まで再実行。
- GUI では Toast 表示＋詳細モーダルでフィードバックする。

## 開発ロードマップ（ドラフト）

1. ドメイン層の基盤整備
   - モデル/リポジトリ/サービスの雛形を作成し、1 オブジェクトのエクスポートを手動テスト。
2. GUI 実装
   - オブジェクト入力テキストエリア、実行フロー、完了画面。
3. 拡張・チューニング
   - 並列数調整、設定保持、履歴画面。

## リスク・懸念

- Bulk API 2.0 の実行権限が組織によって制限されている可能性。GUI で権限不足時のメッセージを分かりやすく出す必要。
- 超大規模データ（>1GB）での結果ファイル取得がタイムアウトする恐れ。チャンクダウンロードや PK Chunking 非対応。
- DescribeSObject の負荷が高いオブジェクト数でレスポンス悪化する。キャッシュ戦略が必要。

## Open Questions

- 現状なし。
